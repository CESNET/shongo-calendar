<ng-container *ngIf="{ dragging: isDragging$ | async } as events">
  <div [ngSwitch]="view" class="shongo-calendar">
    <div class="shongo-calendar__overlay" *ngIf="loading" [@loading]>
      <div class="shongo-calendar__loading">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
    </div>

    <mwl-calendar-day-view
      *ngSwitchCase="CalendarView.Day"
      [viewDate]="viewDate"
      [events]="getCalendarEvents()"
      [eventTemplate]="eventTemplate"
      [tooltipTemplate]="calendarTooltip"
      [hourSegmentTemplate]="hourSegment"
      [hourSegmentHeight]="hourSegmentHeight"
      [refresh]="refresh$"
      [eventTitleTemplate]="eventTitle"
      (eventTimesChanged)="eventTimesChanged($event)"
      (eventClicked)="handleEventClick($event.event)"></mwl-calendar-day-view>

    <mwl-calendar-week-view
      *ngSwitchCase="CalendarView.Week"
      [viewDate]="viewDate"
      [events]="getCalendarEvents()"
      [eventTemplate]="eventTemplate"
      [tooltipTemplate]="calendarTooltip"
      [hourSegmentTemplate]="hourSegment"
      [hourSegmentHeight]="hourSegmentHeight"
      [weekStartsOn]="weekStartsOn"
      [refresh]="refresh$"
      [eventTitleTemplate]="eventTitle"
      (eventTimesChanged)="eventTimesChanged($event)"
      (dayHeaderClicked)="selectDate($event.day.date)"
      (eventClicked)="handleEventClick($event.event)"></mwl-calendar-week-view>

    <mwl-calendar-month-view
      *ngSwitchCase="CalendarView.Month"
      [viewDate]="viewDate"
      [events]="getCalendarEvents()"
      [tooltipTemplate]="calendarTooltip"
      [refresh]="refresh$"
      (dayClicked)="selectDate($event.day.date)"
      (eventClicked)="handleEventClick($event.event)"></mwl-calendar-month-view>
  </div>

  <!-- Hour segment template -->
  <ng-template
    #hourSegment
    let-segment="segment"
    let-locale="locale"
    let-segmentHeight="segmentHeight"
    let-isTimeLabel="isTimeLabel">
    <div
      #segmentElement
      class="cal-hour-segment"
      [style.height.px]="segmentHeight"
      [class.cal-hour-start]="segment.isStart"
      [class.cal-after-hour-start]="!segment.isStart"
      [ngClass]="segment.cssClass"
      (mousedown)="
        allowSlotSelection && startDragToCreate(segment, segmentElement)
      ">
      <div *ngIf="isTimeLabel" class="shongo-calendar__time cal-time">
        {{ segment.date | calendarDate : 'weekViewHour' : locale }}
      </div>
    </div>
  </ng-template>

  <!-- Tooltip template -->
  <ng-template
    #calendarTooltip
    let-contents="contents"
    let-placement="placement"
    let-event="event">
    <div
      [hidden]="events.dragging"
      [ngClass]="'cal-tooltip-' + placement"
      class="shongo-calendar__tooltip cal-tooltip">
      <div class="cal-tooltip-arrow"></div>
      <div class="cal-tooltip-inner">
        <ng-container *ngIf="!event.draggable">
          <b>{{ 'tooltipDescription' | translate }}:</b>
          <span>{{ contents }}</span>
        </ng-container>

        <b>{{ 'tooltipTimeSlot' | translate }}:</b>
        <span>{{ getSlotString(event) }}</span>

        <ng-container *ngIf="getOwner(event) || currentUser as eventOwner">
          <b>{{ 'tooltipReservedBy' | translate }}:</b>
          <span>
            <ng-container
              *ngTemplateOutlet="
                ownerData;
                context: {
                  eventOwner
                }
              "></ng-container>
          </span>
        </ng-container>
      </div>
    </div>
  </ng-template>

  <!-- Event title template -->
  <ng-template #eventTitle let-event="event" let-view="view">
    <span
      class="shongo-calendar__title cal-event-title"
      [attr.aria-hidden]="{} | calendarA11y : 'hideEventTitle'">
      {{ event.title | calendarEventTitle : view : event }}
    </span>
  </ng-template>

  <ng-template #ownerData let-eventOwner="eventOwner">
    <span *ngIf="eventOwner; else unknownOwner">
      {{ eventOwner.name }}
      <span *ngIf="eventOwner.email as email">
        (<a href="mailto:{{ email }}">{{ email }}</a
        >)
      </span>
    </span>
  </ng-template>

  <!-- Event template -->
  <ng-template
    #eventTemplate
    let-weekEvent="weekEvent"
    let-tooltipPlacement="tooltipPlacement"
    let-eventClicked="eventClicked"
    let-tooltipTemplate="tooltipTemplate"
    let-tooltipAppendToBody="tooltipAppendToBody"
    let-tooltipDisabled="tooltipDisabled"
    let-tooltipDelay="tooltipDelay"
    let-column="column"
    let-daysInWeek="daysInWeek">
    <div
      class="cal-event"
      [ngStyle]="{
        color: weekEvent.event.color?.secondaryText,
        backgroundColor: weekEvent.event.color?.secondary,
        borderColor: weekEvent.event.color?.primary
      }"
      [mwlCalendarTooltip]="
        !tooltipDisabled
          ? (weekEvent.event.title
            | calendarEventTitle
              : (daysInWeek === 1 ? 'dayTooltip' : 'weekTooltip')
              : weekEvent.tempEvent || weekEvent.event)
          : ''
      "
      [tooltipPlacement]="tooltipPlacement"
      [tooltipEvent]="weekEvent.tempEvent || weekEvent.event"
      [tooltipTemplate]="tooltipTemplate"
      [tooltipAppendToBody]="tooltipAppendToBody"
      [tooltipDelay]="tooltipDelay"
      (mwlClick)="eventClicked.emit({ sourceEvent: $event })"
      (mwlKeydownEnter)="eventClicked.emit({ sourceEvent: $event })"
      tabindex="0"
      role="application"
      [attr.aria-label]="
        { event: weekEvent.tempEvent || weekEvent.event, locale: locale }
          | calendarA11y : 'eventDescription'
      ">
      <div [class.unselectable]="isDragging$ | async">
        <mwl-calendar-event-actions
          [event]="weekEvent.tempEvent || weekEvent.event">
        </mwl-calendar-event-actions>
        &nbsp;
        <mwl-calendar-event-title
          [event]="weekEvent.tempEvent || weekEvent.event"
          [view]="daysInWeek === 1 ? 'day' : 'week'">
        </mwl-calendar-event-title>
      </div>
    </div>
  </ng-template>

  <ng-template #unknownOwner>
    <span>{{ 'unknown' | translate }}</span>
  </ng-template>
</ng-container>
